<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°ng Sinh Lung Linh - Noel 2025</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #canvas-wrapper { position: relative; width: 100vw; height: 100vh; }
        #canvas-container { width: 100%; height: 100%; display: block; }
        
        #video-container {
            position: absolute; top: 20px; right: 20px; width: 160px; height: 120px; z-index: 2;
            border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; overflow: hidden;
            transform: scaleX(-1); background: rgba(0,0,0,0.5); box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #input-video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; position: absolute; top:0; left:0; }
        #skeleton-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }

        #ui-layer {
            position: absolute; top: 30px; left: 30px; z-index: 3; color: #fff; pointer-events: none;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        h1 { 
            margin: 0 0 10px 0; font-weight: 200; letter-spacing: 4px; text-transform: uppercase;
            background: linear-gradient(to right, #fff, #ffd700, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        
        .instructions {
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; border-left: 3px solid #ffd700;
            max-width: 320px; font-size: 0.9rem; line-height: 1.6; backdrop-filter: blur(5px);
        }
        .highlight { color: #ffd700; font-weight: bold; }
        
        #btn-group { margin-top: 20px; pointer-events: auto; }
        button {
            padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer;
            font-weight: bold; margin-right: 10px; transition: 0.3s; font-size: 0.9rem;
        }
        #upload-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid #888; }
        #share-btn { background: linear-gradient(45deg, #ffd700, #ffaa00); color: #000; display: none; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); border: none; }
        button:hover { transform: scale(1.05); filter: brightness(1.2); }

        #file-input { display: none; }
        
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ffd700; font-size: 1.5rem; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.85); padding: 30px; border-radius: 15px; display: none; border: 1px solid #ffd700;
        }

        #share-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;
        }
        #share-modal.show { display: flex; }
        #share-box { background: #222; padding: 30px; border-radius: 15px; text-align: center; color: white; border: 1px solid #ffd700; max-width: 90%; }
        #share-url { width: 100%; max-width: 400px; padding: 12px; border-radius: 5px; border: 1px solid #555; margin: 15px 0; text-align: center; background: #111; color: #ffd700; font-size: 14px; }

        .hide-ui #ui-layer { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        .hide-ui #fullscreen-btn { opacity: 0.3; }
        
        #fullscreen-btn {
            position: absolute; top: 30px; right: 200px; z-index: 20;
            background: rgba(0,0,0,0.5); color: #d4af37; border: 1px solid #d4af37;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: all 0.3s;
        }
        #fullscreen-btn:hover { background: #d4af37; color: #000; opacity: 1; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <audio id="bg-music" src="https://incompetech.com/music/royalty-free/mp3-royaltyfree/Jingle%20Bells.mp3" loop></audio>

    <div id="canvas-wrapper">
        <div id="canvas-container"></div>
        <div id="video-container">
            <video id="input-video" autoplay playsinline muted></video>
            <canvas id="skeleton-canvas" width="640" height="480"></canvas>
        </div>

        <button id="fullscreen-btn" onclick="toggleUI()" title="To√†n m√†n h√¨nh"> ‚õ∂ </button>

        <div id="ui-layer">
            <h1>Noel 2025</h1>
            <div id="status-text">Tr·∫°ng th√°i: <span style="color:#00ff00">S·∫µn s√†ng</span></div>
            <div class="instructions">
                üñêÔ∏è <b>M·ªü tay:</b> H·∫°t ph√¢n t√°n<br>
                ‚úä <b>N·∫Øm tay:</b> T·ª• th√†nh C√¢y Th√¥ng<br>
                ü§è <b>Ch·ª•m (C√°i+Tr·ªè):</b> Zoom v√†o ·∫£nh
            </div>
            <div id="btn-group">
                <button id="upload-btn" onclick="document.getElementById('file-input').click()">üì∏ Ch·ªçn ·∫¢nh</button>
                <input type="file" id="file-input" multiple accept="image/*">
                <button id="share-btn" onclick="saveToDatabase()">‚òÅÔ∏è L∆∞u & Chia S·∫ª</button>
            </div>
        </div>
        <div id="loading">ƒêang x·ª≠ l√Ω...</div>
    </div>

    <div id="share-modal">
        <div id="share-box">
            <h3 style="color:#ffd700">üéÅ H·ªôp qu√† ƒë√£ s·∫µn s√†ng!</h3>
            <p>G·ª≠i ƒë∆∞·ªùng link n√†y cho ng∆∞·ªùi b·∫°n mu·ªën t·∫∑ng:</p>
            <input type="text" id="share-url" readonly onclick="this.select()">
            <br>
            <button onclick="document.getElementById('share-modal').classList.remove('show')" style="background:#555; color:white; border:none; padding:10px 30px; margin-top:10px; border-radius:20px; cursor:pointer;">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0';

        // ------------------------------------------------------------------
        // 1. C·∫§U H√åNH (ƒê√É ƒêI·ªÄN ƒê·ª¶)
        // ------------------------------------------------------------------
        
        const IMGBB_API_KEY = 'fd742c3948f8cf8f60e57cb4229df53d';

        // C·∫•u h√¨nh Firebase c·ªßa b·∫°n
        const firebaseConfig = {
            apiKey: "AIzaSyCUzhyAfn8slxxpkZCl6cl0rwx9r5lvs7g",
            authDomain: "noel-97d6e.firebaseapp.com",
            projectId: "noel-97d6e",
            storageBucket: "noel-97d6e.firebasestorage.app",
            messagingSenderId: "958119173508",
            appId: "1:958119173508:web:b2837964b8f975449c51d1",
            measurementId: "G-80YM9M8QCL"
        };

        // Kh·ªüi t·∫°o Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase connected successfully!");
        } catch(e) {
            console.error("Firebase Init Error:", e);
            alert("L·ªói k·∫øt n·ªëi Database!");
        }

        // ------------------------------------------------------------------
        // 2. LOGIC L∆ØU TR·ªÆ & CHIA S·∫∫
        // ------------------------------------------------------------------
        let uploadedFiles = []; 
        let uploadedUrls = [];  

        // Ch·ªçn ·∫£nh t·ª´ m√°y
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = e.target.files;
            if(!files.length) return;
            
            // Preview ·∫£nh ngay l·∫≠p t·ª©c
            for(let i=0; i<files.length; i++){
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.src = evt.target.result;
                    img.onload = () => addPhotoMesh(img);
                    uploadedFiles.push(files[i]);
                };
                reader.readAsDataURL(files[i]);
            }
            
            setTimeout(() => {
                document.getElementById('share-btn').style.display = 'inline-block';
                document.getElementById('status-text').innerHTML = `ƒê√£ th√™m <span style="color:#ffd700">${files.length} ·∫£nh</span>`;
                alert(`ƒê√£ th√™m ${files.length} ·∫£nh. H√£y b·∫•m "L∆∞u & Chia S·∫ª" ƒë·ªÉ t·∫°o link qu√† t·∫∑ng!`);
            }, 1000);
        });

        // L∆∞u v√†o Database
        window.saveToDatabase = async function() {
            if(!db) return;
            if(uploadedFiles.length === 0) { alert("B·∫°n ch∆∞a ch·ªçn ·∫£nh n√†o!"); return; }

            const btn = document.getElementById('share-btn');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ ƒêang t·∫£i l√™n...";
            btn.disabled = true;

            try {
                // B1: Upload ·∫£nh l√™n ImgBB
                uploadedUrls = [];
                for(let i=0; i<uploadedFiles.length; i++) {
                    btn.innerText = `Up ·∫£nh ${i+1}/${uploadedFiles.length}...`;
                    const formData = new FormData();
                    formData.append("image", uploadedFiles[i]);
                    
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: "POST", body: formData
                    });
                    const data = await res.json();
                    if(data.success) uploadedUrls.push(data.data.url);
                }

                // B2: L∆∞u link v√†o Firebase
                if(uploadedUrls.length > 0) {
                    btn.innerText = "L∆∞u Database...";
                    const docRef = await addDoc(collection(db, "wishes"), {
                        photos: uploadedUrls,
                        createdAt: new Date().toISOString()
                    });

                    // B3: T·∫°o link chia s·∫ª
                    const shareLink = window.location.href.split('?')[0] + "?id=" + docRef.id;
                    document.getElementById('share-url').value = shareLink;
                    document.getElementById('share-modal').classList.add('show');
                } else {
                    alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh n√†o l√™n Server :(");
                }

            } catch(e) {
                alert("L·ªói: " + e.message);
                console.error(e);
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        };

        // Load t·ª´ Database
        async function loadFromDatabase() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if(!id) return false;

            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.innerText = "üéÅ ƒêang t·∫£i h·ªôp qu√†...";
            document.getElementById('canvas-wrapper').classList.add('hide-ui'); // ·∫®n UI upload

            try {
                if(!db) throw new Error("Database ch∆∞a s·∫µn s√†ng");
                const docSnap = await getDoc(doc(db, "wishes", id));
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const photos = data.photos || [];
                    
                    document.getElementById('status-text').innerHTML = `üéÑ Album: <span style="color:#ffd700">${photos.length} ·∫£nh</span>`;
                    
                    let loadedCount = 0;
                    for(let url of photos) {
                        const img = new Image();
                        img.crossOrigin = "Anonymous";
                        img.src = url;
                        await new Promise(r => { 
                            img.onload = () => { addPhotoMesh(img); loadedCount++; r(); }; 
                            img.onerror = r; 
                        });
                    }
                    if(loadedCount > 0) currentState = STATE.TREE; // M·∫∑c ƒë·ªãnh v·ªÅ c√¢y th√¥ng
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y h·ªôp qu√† n√†y (C√≥ th·ªÉ ƒë√£ b·ªã x√≥a)");
                }
            } catch(e) {
                console.error(e);
                alert("L·ªói t·∫£i d·ªØ li·ªáu h·ªôp qu√†.");
            }
            loading.style.display = 'none';
            return true;
        }

        // ------------------------------------------------------------------
        // 3. 3D & LOGIC (ZOOM FIXED)
        // ------------------------------------------------------------------
        const STATE = { TREE: 0, SCATTER: 1, ZOOM: 2 };
        let currentState = STATE.TREE;
        
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 80;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Post-processing (Glow)
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85));

        const mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // Objects
        const photoMeshes = [];
        let particles;
        
        // T·∫°o h·∫°t (Tuy·∫øt/Sao)
        function createParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<1500; i++) {
                const r = 40 * Math.cbrt(Math.random());
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2*Math.random()-1);
                pos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            particles = new THREE.Points(geo, new THREE.PointsMaterial({color: 0xffd700, size: 0.4, transparent: true, opacity: 0.8}));
            mainGroup.add(particles);
        }
        createParticles();

        // T·∫°o ·∫£nh 3D
        function addPhotoMesh(img) {
            const tex = new THREE.Texture(img);
            tex.needsUpdate = true;
            tex.colorSpace = THREE.SRGBColorSpace;
            
            const aspect = img.width / img.height;
            const h = 6; 
            const w = h * aspect;

            const geo = new THREE.PlaneGeometry(w, h);
            const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
            const mesh = new THREE.Mesh(geo, mat);
            
            // Khung ·∫£nh
            const frame = new THREE.Mesh(new THREE.BoxGeometry(w+0.3, h+0.3, 0.1), new THREE.MeshBasicMaterial({color: 0x8B4513}));
            frame.position.z = -0.06;
            mesh.add(frame);

            // V·ªã tr√≠ tr√™n c√¢y (H√¨nh n√≥n xo·∫Øn)
            const y = (Math.random() - 0.5) * 60; // Chi·ªÅu cao
            const r = 18 * (1 - (y+35)/75) + 2;   // B√°n k√≠nh (nh·ªè d·∫ßn l√™n ƒë·ªânh)
            const angle = Math.random() * Math.PI * 2;
            
            const treePos = new THREE.Vector3(r*Math.cos(angle), y, r*Math.sin(angle));
            const scatterPos = new THREE.Vector3((Math.random()-0.5)*90, (Math.random()-0.5)*90, (Math.random()-0.5)*90);

            mesh.userData = { treePos, scatterPos, angle };
            mesh.position.copy(treePos);
            mesh.lookAt(0, y, 0); // Nh√¨n v√†o tr·ª•c gi·ªØa
            mesh.rotateY(Math.PI); // Quay m·∫∑t ra ngo√†i
            
            // L∆∞u rotation c∆° b·∫£n ƒë·ªÉ khi zoom out n√≥ quay v·ªÅ ƒë√∫ng h∆∞·ªõng n√†y
            mesh.userData.baseRot = mesh.rotation.clone();

            photoMeshes.push(mesh);
            mainGroup.add(mesh);
        }

        // Logic Update Frame
        function updateScene() {
            // Xoay h·∫°t
            if(particles) particles.rotation.y += 0.002;

            if(currentState === STATE.TREE) {
                mainGroup.rotation.y += 0.003; // C√¢y t·ª± xoay nh·∫π
                photoMeshes.forEach(m => {
                    m.position.lerp(m.userData.treePos, 0.05);
                    m.quaternion.slerp(new THREE.Quaternion().setFromEuler(m.userData.baseRot), 0.05);
                    m.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
                });
            } 
            else if(currentState === STATE.SCATTER) {
                mainGroup.rotation.y += 0.001;
                photoMeshes.forEach(m => {
                    m.position.lerp(m.userData.scatterPos, 0.05);
                    m.lookAt(camera.position); // Lu√¥n nh√¨n camera
                    m.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
                });
            }
            else if(currentState === STATE.ZOOM) {
                // ·ªû ch·∫ø ƒë·ªô Zoom:
                // 1. T√¨m ·∫£nh ƒëang ƒë∆∞·ª£c ch·ªçn (zoomTargetIndex)
                // 2. ƒê∆∞a n√≥ v·ªÅ tr∆∞·ªõc camera
                // 3. ƒê·∫©y c√°c ·∫£nh kh√°c ra xa/l√†m nh·ªè ƒëi
                
                photoMeshes.forEach((m, idx) => {
                    if(idx === zoomTargetIndex) {
                        // V·ªã tr√≠ tr∆∞·ªõc camera (trong Local Space c·ªßa mainGroup)
                        // V√¨ camera ·ªü World (0,0,80), ta mu·ªën ·∫£nh ·ªü World (0,0,60) ch·∫≥ng h·∫°n
                        // Nh∆∞ng mainGroup ƒëang xoay, n√™n ta ph·∫£i t√≠nh ng∆∞·ª£c
                        
                        const targetWorld = new THREE.Vector3(0, 0, 65);
                        const targetLocal = mainGroup.worldToLocal(targetWorld.clone());
                        
                        m.position.lerp(targetLocal, 0.1);
                        m.lookAt(camera.position);
                        m.scale.lerp(new THREE.Vector3(2.5, 2.5, 2.5), 0.1); // Ph√≥ng to
                    } else {
                        m.scale.lerp(new THREE.Vector3(0.1, 0.1, 0.1), 0.1); // Thu nh·ªè ·∫£nh kh√°c
                    }
                });
            }
        }

        // --- 4. AI NH·∫¨N DI·ªÜN TAY ---
        let handLandmarker;
        let zoomTargetIndex = -1;

        async function setupAI() {
            const video = document.getElementById("input-video");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch(e) { console.log("Camera error", e); return; }

            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: "VIDEO", numHands: 1
            });
            detectLoop();
        }

        async function detectLoop() {
            const video = document.getElementById("input-video");
            if(video.currentTime > 0 && handLandmarker) {
                const res = handLandmarker.detectForVideo(video, performance.now());
                
                const canvas = document.getElementById('skeleton-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,640,480);

                if(res.landmarks.length > 0) {
                    const lm = res.landmarks[0];
                    drawSkeleton(ctx, lm);
                    processGesture(lm);
                }
            }
            requestAnimationFrame(detectLoop);
        }

        function processGesture(lm) {
            // T√≠nh to√°n c·ª≠ ch·ªâ
            const thumbTip = lm[4];
            const indexTip = lm[8];
            const pinchDist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
            const isPinch = pinchDist < 0.05;

            // ƒê·∫øm ng√≥n tay g·∫≠p (ƒë·ªÉ x√°c ƒë·ªãnh n·∫Øm tay)
            const wrist = lm[0];
            const tips = [8, 12, 16, 20];
            let folded = 0;
            tips.forEach(idx => {
                const d = Math.hypot(lm[idx].x - wrist.x, lm[idx].y - wrist.y);
                if(d < 0.25) folded++;
            });
            const isFist = folded >= 3;

            const status = document.getElementById('status-text');

            if(isPinch) {
                // CH·∫æ ƒê·ªò ZOOM
                if(currentState !== STATE.ZOOM && photoMeshes.length > 0) {
                    // T√¨m ·∫£nh g·∫ßn camera nh·∫•t
                    let minD = Infinity;
                    let bestIdx = -1;
                    const camPos = camera.position;
                    const worldPos = new THREE.Vector3();
                    
                    photoMeshes.forEach((m, i) => {
                        m.getWorldPosition(worldPos);
                        const d = worldPos.distanceTo(camPos);
                        if(d < minD) { minD = d; bestIdx = i; }
                    });
                    
                    if(bestIdx !== -1) {
                        zoomTargetIndex = bestIdx;
                        currentState = STATE.ZOOM;
                        status.innerHTML = "Tr·∫°ng th√°i: <span style='color:#ffd700'>ZOOM ·∫¢NH</span>";
                    }
                }
            } 
            else if(isFist) {
                // CH·∫æ ƒê·ªò C√ÇY TH√îNG
                currentState = STATE.TREE;
                status.innerHTML = "Tr·∫°ng th√°i: <span style='color:#00ff00'>C√ÇY TH√îNG</span>";
            } 
            else {
                // CH·∫æ ƒê·ªò PH√ÇN T√ÅN (M·∫∑c ƒë·ªãnh khi m·ªü tay)
                if(currentState !== STATE.ZOOM) { // N·∫øu ƒëang zoom th√¨ ph·∫£i m·ªü tay d·ª©t kho√°t m·ªõi tho√°t
                     currentState = STATE.SCATTER;
                     status.innerHTML = "Tr·∫°ng th√°i: <span style='color:#00aaff'>PH√ÇN T√ÅN</span>";
                }
            }
        }

        function drawSkeleton(ctx, landmarks) {
            ctx.fillStyle = '#00ff00';
            landmarks.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x * 640, p.y * 480, 3, 0, 2*Math.PI);
                ctx.fill();
            });
        }

        // --- Main Loop ---
        function animateLoop() {
            requestAnimationFrame(animateLoop);
            updateScene();
            composer.render();
        }

        // --- Start ---
        initThree();
        setupAI();
        loadFromDatabase(); // Check URL ID
        animateLoop();

        // Music Trigger
        function playMusic() { 
            const m = document.getElementById('bg-music');
            m.volume = 0.5;
            m.play().catch(()=>{}); 
        }
        document.body.addEventListener('click', playMusic);
        document.body.addEventListener('touchstart', playMusic);

    </script>
</body>
</html>